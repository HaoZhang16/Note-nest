<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ä¸»é¡µ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/home.css') }}">
</head>
<script>
fetch("/contribution_data")
  .then(res => res.json())
  .then(data => {
    const container = document.getElementById("contribution-graph");
    container.innerHTML = '';  // æ¸…ç©ºæ—§æ•°æ®
    data.forEach(day => {
        const cell = document.createElement("div");
        cell.className = "graph-cell";
        cell.dataset.count = Math.min(day.count, 6);  // é™åˆ¶æœ€å¤§é¢œè‰²ç­‰çº§
        cell.title = `${day.date}: ${day.count} æ¡ç¬”è®°`;
        container.appendChild(cell);
    });
});
</script>
<body>
    <div class="header">
        <div>æ¬¢è¿ï¼Œ{{ username }}</div>
        <div class="header-actions">
            <form action="/setting" method="post">
                <button type="submit" class="setting-btn">è®¾ç½®</button>
            </form>
            <form action="/logout" method="post">
                <button type="submit" class="logout-btn">é€€å‡ºç™»å½•</button>
            </form>
        </div>
    </div>

    <div class="main-container">
        <!-- å·¦ä¾§æ“ä½œåŒºåŸŸ -->
        <div class="left-panel">

            <!-- æœç´¢æ¡† -->
            <form class="search-form" action="/search" method="get">
                <input type="text" name="q" placeholder="æœç´¢ä¹¦ç±/ä½œè€…/ç¬”è®°/æ ‡ç­¾/å¼•æ–‡" required>
                <select name="type">
                    <option value="book">ä¹¦ç±</option>
                    <option value="note">ç¬”è®°</option>
                </select>

                <input type="submit" value="æœç´¢">
            </form>


            <div class="button-and-heatmap">
                <div class="btn-column">
                    <form action="/add_book" method="get" class="btn-form">
                        <input type="submit" value="æ·»åŠ ä¹¦ç±" class="btn">
                    </form>
                    <form action="/add_note" method="get" class="btn-form">
                        <input type="submit" value="æ·»åŠ ç¬”è®°" class="btn">
                    </form>
                    <form action="/notes" method="get" class="btn-form">
                        <input type="submit" value="æŸ¥çœ‹ç¬”è®°" class="btn">
                    </form>
                    <form action="/review" method="get" class="btn-form">
                        <input type="submit" value="å¼€å§‹å¤ä¹ " class="btn">
                    </form>
                </div>


                <div id="contribution-graph" class="graph-grid"></div>
            </div>
            <!-- å¥½å‹åˆ—è¡¨ -->
            <div class="friend-list">
                <h4>ğŸ‘¥ å¥½å‹åˆ—è¡¨</h4>
                {% if friends %}
                    <ul class="friend-ul">
                        {% for f in friends %}
                            <li class="friend-item">
                                <span class="friend-name">{{ f.user_name }}</span>
                                <span class="note-time">æœ€è¿‘åˆ›å»º: {{ f.latest_note_time }}</span>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>æš‚æ— å¥½å‹</p>
                {% endif %}

                <hr>
                <h5>æ·»åŠ å¥½å‹</h5>
                <form method="POST" action="{{ url_for('home.add_friend') }}">
                    <input type="text" name="friend_name" placeholder="è¾“å…¥ç”¨æˆ·å" class="search-friend">
                    <button type="submit" class="btn-add">æ·»åŠ </button>
                </form>

                {% if search_result %}
                    <p>æ‰¾åˆ°ç”¨æˆ·ï¼š{{ search_result.user_name }} âœ…</p>
                {% elif search_error %}
                    <p style="color: red;">{{ search_error }}</p>
                {% endif %}
            </div>
        </div>

        <!-- å³ä¾§ä¹¦åº“å±•ç¤º -->
        <div class="right-panel">
            <h3>ğŸ“š ä¹¦åº“</h3>
            {% for book in books %}
                <div class="book-item">
                    <a href="{{ url_for('book.related_notes', book_id=book.book_id) }}">
                        <img src="{{ url_for('static', filename=book.cover_path or 'covers/default_cover.jpg') }}" alt="å°é¢">
                    </a>
                    <div class="book-title">{{ book.title }}</div>
                </div>
            {% endfor %}
            <a class="link" href="/library">æ›´å¤š...</a>
        </div>
    </div>
</body>
</html>
